<div class="admin-page">
  <h1>Users</h1>

  <!-- Create User Section -->
  <div class="create-section">
    <h2>Create Account</h2>
    <form [formGroup]="createForm" (ngSubmit)="createUser()">
      <input formControlName="email" type="email" placeholder="Email">
      <input formControlName="password" type="password" placeholder="Password">
      <select formControlName="role">
        <option *ngFor="let r of roles" [value]="r.value">{{ r.label }}</option>
      </select>

      <!-- Only show for Admins -->
      <div *ngIf="createForm.value.role == 1" style="margin:0.5rem 0;">
        <label>
          <input type="checkbox" formControlName="can_create_admins">
          Can create other admins
        </label>
      </div>

      <button type="submit" [disabled]="createForm.invalid || loading">
        {{ loading ? 'Creating...' : 'Create User' }}
      </button>
    </form>
  </div>

  <!-- Search & Role Filter -->
  <div class="admin-filters" style="margin: 1rem 0; display: flex; gap: 0.5rem;">
    <input
      type="text"
      placeholder="Search by name or email..."
      [(ngModel)]="searchTerm"
      (ngModelChange)="onSearchChange($event)"
    />
    <select [(ngModel)]="filterRole" (ngModelChange)="onRoleFilterChange($event)">
      <option value="">All Roles</option>
      <option *ngFor="let role of roles" [value]="role.value">{{ role.label }}</option>
    </select>
  </div>

  <!-- Users Table -->
  <div class="table-section">
    <h2>All Users</h2>
    <table>
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers">
          <td>{{ user.full_name || 'N/A' }}</td>
          <td>{{ user.email }}</td>
          <td>
            {{ getRoleLabel(user.role) }}
            <span *ngIf="user.role == 1 && user.can_create_admins" title="Can create admins">
              ðŸ”‘
            </span>
          </td>
          <td>
            <button (click)="selectUser(user)">Edit</button>
            <button (click)="deleteUser(user.id)">Delete</button>
          </td>
        </tr>

        <tr *ngIf="filteredUsers.length === 0">
          <td colspan="4" style="text-align: center;">No users found.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Edit User Section -->
  <div *ngIf="selectedUser" class="edit-section">
    <h2>Edit User: {{ selectedUser.email }}</h2>
    <form [formGroup]="editForm" (ngSubmit)="updateUser()">
      <input formControlName="email" type="email" placeholder="Email">
      <select formControlName="role">
        <option *ngFor="let r of roles" [value]="r.value">{{ r.label }}</option>
      </select>

      <!-- Only show for Admins -->
      <div *ngIf="editForm.value.role == 1" style="margin:0.5rem 0;">
        <label>
          <input type="checkbox" formControlName="can_create_admins">
          Can create other admins
        </label>
      </div>

      <input formControlName="password" type="password" placeholder="New Password (optional)">
      <button type="submit" [disabled]="editForm.invalid || loading">
        {{ loading ? 'Updating...' : 'Update User' }}
      </button>
      <button type="button" (click)="cancelEdit()">Cancel</button>
    </form>
  </div>
</div>
